{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8 max-w-2xl">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Review Network Request #{{ rule.id }}</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>Source IP:</strong> <span class="font-semibold text-gray-800">{{ rule.source_ip }}</span></p>
            <p class="text-gray-600"><strong>Destination IP:</strong> <span class="font-semibold text-gray-800">{{ rule.destination_ip }}</span></p>
            <p class="text-gray-600"><strong>Protocol:</strong> <span class="font-semibold text-gray-800">{{ rule.protocol }}</span></p>
            <p class="text-gray-600"><strong>Port:</strong> <span class="font-semibold text-gray-800">{{ rule.port }}</span></p>
        </div>
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>Current Status:</strong> <span class="font-semibold text-blue-600">{{ rule.status }}</span></p>
            <p class="text-gray-600"><strong>Approval Status:</strong> <span class="font-semibold text-purple-600">{{ rule.approval_status }}</span></p>
            <p class="text-gray-600"><strong>Approver Comments:</strong> <span class="text-gray-800">{{ rule.approver_comment if rule.approver_comment else 'N/A' }}</span></p>
            <p class="text-gray-600"><strong>Firewalls Involved:</strong> 
                {% if rule.firewalls_involved %}
                    <span class="font-semibold text-gray-800">{{ rule.firewalls_involved | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">N/A (Pathfinding might not have identified firewalls or an error occurred)</span>
                {% endif %}
            </p>
            
            {# NEW: Display firewalls to provision and already configured #}
            <p class="text-gray-600 mt-2"><strong>Firewalls Requiring Provisioning:</strong> 
                {% if rule.firewalls_to_provision %}
                    <span class="font-semibold text-red-600">{{ rule.firewalls_to_provision | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None</span>
                {% endif %}
            </p>
            <p class="text-gray-600"><strong>Firewalls Already Configured:</strong> 
                {% if rule.firewalls_already_configured %}
                    <span class="font-semibold text-green-600">{{ rule.firewalls_already_configured | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None</span>
                {% endif %}
            </p>
        </div>
    </div>

    <h3 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Approver Action</h3>
    {% if rule.approval_status == 'Pending' %}
    <form method="POST" action="{{ url_for('routes.approve_deny_request', rule_id=rule.id) }}" class="space-y-4">
        <div>
            <label for="approver_comment" class="block text-gray-700 text-sm font-bold mb-2">Comments:</label>
            <textarea id="approver_comment" name="approver_comment" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-y"></textarea>
        </div>
        
        <div class="flex justify-center space-x-4">
            <button type="submit" name="action" value="approve" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Approve</button>
            <button type="submit" name="action" value="deny" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Deny</button>
        </div>
    </form>
    {# Adjusting text and button visibility based on the new logic for 'Approved - No Provisioning Needed' #}
    {% elif rule.status == 'Approved - Pending Implementation' %}
        <p class="text-center text-lg text-green-700 mb-4">This request has been approved and is ready for provisioning.</p>
        <form method="POST" action="{{ url_for('routes.provision_request', rule_id=rule.id) }}" class="flex justify-center">
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Trigger Provisioning</button>
        </form>
    {% elif rule.status == 'Completed - No Provisioning Needed' %}
        <p class="text-center text-lg text-green-700 mb-4">This request was approved and identified as not requiring any provisioning. It is now completed.</p>
    {% else %}
        <p class="text-center text-lg text-gray-600">This request is {{ rule.status }}. No further approval/provisioning action is available here.</p>
    {% endif %}

    <div class="text-center mt-8">
        <a href="{{ url_for('routes.approvals_list') }}" class="text-blue-500 hover:text-blue-700 text-sm font-semibold">‚Üê Back to Approvals List</a>
    </div>
</div>
{% endblock %}
