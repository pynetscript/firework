{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Dashboard</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-50 p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">System Status</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">CPU Load:</td>
                        <td id="cpu_load" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Memory Load:</td>
                        <td id="memory_load" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Disk Space Left:</td>
                        <td id="disk_space" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Bandwidth (ens33):</td>
                        <td id="bandwidth" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Firework App:</td>
                        <td id="app_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Nginx:</td>
                        <td id="nginx_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Gunicorn:</td>
                        <td id="gunicorn_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">PostgreSQL:</td>
                        <td id="postgres_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Application Status</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Open Tickets:</td>
                        <td id="open_tickets" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Pending Approval:</td>
                        <td id="pending_approval" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Pending Implementation:</td>
                        <td id="pending_implementation" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Closed/Implemented Tickets:</td>
                        <td id="closed_implemented" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Variables to store previous bandwidth data for calculation
    let prevBytesSent = 0;
    let prevBytesRecv = 0;
    let lastBandwidthFetchTime = 0; // Timestamp of the last fetch

    // Helper function to format bytes per second
    function formatBytesPerSecond(bytes) {
        if (bytes < 1024) {
            return `${bytes.toFixed(1)} B/s`;
        } else if (bytes < 1024 * 1024) {
            return `${(bytes / 1024).toFixed(1)} KB/s`;
        } else if (bytes < 1024 * 1024 * 1024) {
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB/s`;
        } else {
            return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB/s`;
        }
    }

    // Function to fetch and update System Status (including bandwidth rate)
    async function fetchSystemStatus() {
        try {
            const response = await fetch('/api/dashboard/system-status');
            const data = await response.json();
            const currentTime = Date.now(); // Current timestamp in milliseconds

            document.getElementById('cpu_load').textContent = data.cpu_load || 'N/A';
            document.getElementById('memory_load').textContent = data.memory_load || 'N/A';
            document.getElementById('disk_space').textContent = data.disk_space || 'N/A';
            document.getElementById('app_status').textContent = data.firework_app || 'N/A';
            document.getElementById('nginx_status').textContent = data.nginx || 'N/A';
            document.getElementById('gunicorn_status').textContent = data.gunicorn || 'N/A';
            document.getElementById('postgres_status').textContent = data.postgres || 'N/A';

            // --- Bandwidth Calculation Logic ---
            if (data.bandwidth_error) {
                document.getElementById('bandwidth').textContent = data.bandwidth_error;
            } else if (lastBandwidthFetchTime === 0) {
                // First fetch, just initialize and show "Collecting data..."
                document.getElementById('bandwidth').textContent = 'Collecting data...';
            } else {
                const timeDiffSeconds = (currentTime - lastBandwidthFetchTime) / 1000; // Convert ms to seconds

                if (timeDiffSeconds > 0) {
                    const sentDiff = data.bandwidth_bytes_sent - prevBytesSent;
                    const recvDiff = data.bandwidth_bytes_recv - prevBytesRecv;

                    // Ensure no negative differences if counter reset (though psutil should handle nowrap)
                    const actualSentDiff = Math.max(0, sentDiff);
                    const actualRecvDiff = Math.max(0, recvDiff);

                    const sentRate = actualSentDiff / timeDiffSeconds;
                    const recvRate = actualRecvDiff / timeDiffSeconds;

                    document.getElementById('bandwidth').textContent =
                        `Sent: ${formatBytesPerSecond(sentRate)}, Recv: ${formatBytesPerSecond(recvRate)}`;
                } else {
                    document.getElementById('bandwidth').textContent = 'Calculating...'; // Should ideally not happen
                }
            }

            // Store current values for the next calculation
            prevBytesSent = data.bandwidth_bytes_sent;
            prevBytesRecv = data.bandwidth_bytes_recv;
            lastBandwidthFetchTime = currentTime;

        } catch (error) {
            console.error('Error fetching system status:', error);
            document.getElementById('cpu_load').textContent = 'Error';
            document.getElementById('memory_load').textContent = 'Error';
            document.getElementById('disk_space').textContent = 'Error';
            document.getElementById('bandwidth').textContent = 'Error'; // Set to error on fetch failure
            document.getElementById('app_status').textContent = 'Error';
            document.getElementById('nginx_status').textContent = 'Error';
            document.getElementById('gunicorn_status').textContent = 'Error';
            document.getElementById('postgres_status').textContent = 'Error';
        }
    }

    // Function to fetch and update Application Status (remains unchanged)
    async function fetchApplicationStatus() {
        try {
            const response = await fetch('/api/dashboard/application-status');
            const data = await response.json();

            document.getElementById('open_tickets').textContent = data.open_tickets !== undefined ? data.open_tickets : 'N/A';
            document.getElementById('pending_approval').textContent = data.pending_approval !== undefined ? data.pending_approval : 'N/A';
            document.getElementById('pending_implementation').textContent = data.pending_implementation !== undefined ? data.pending_implementation : 'N/A';
            document.getElementById('closed_implemented').textContent = data.closed_implemented !== undefined ? data.closed_implemented : 'N/A';

        } catch (error) {
            console.error('Error fetching application status:', error);
            document.getElementById('open_tickets').textContent = 'Error';
            document.getElementById('pending_approval').textContent = 'Error';
            document.getElementById('pending_implementation').textContent = 'Error';
            document.getElementById('closed_implemented').textContent = 'Error';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Fetch data initially
        fetchSystemStatus(); // Call first to initialize bandwidth counters
        fetchApplicationStatus();

        // Refresh data periodically
        // System status (including bandwidth) should update more frequently
        setInterval(fetchSystemStatus, 3000); // Update every 3 seconds for fresher bandwidth data
        // Application status can update less frequently as it changes less often
        setInterval(fetchApplicationStatus, 15000); // Update every 15 seconds
    });
</script>
{% endblock %}
