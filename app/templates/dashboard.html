{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8">

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-50 p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">System Status</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">CPU:</td>
                        <td id="cpu_load" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Memory:</td>
                        <td id="memory_load" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Disk Space:</td>
                        <td id="disk_space" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Bandwidth:</td>
                        <td id="bandwidth" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Firework:</td>
                        <td id="app_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Nginx:</td>
                        <td id="nginx_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Gunicorn:</td>
                        <td id="gunicorn_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">PostgreSQL:</td>
                        <td id="postgres_status" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Application Status</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Open:</td>
                        <td id="open_tickets" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Pending Approval:</td>
                        <td id="pending_approval" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Pending Implementation:</td>
                        <td id="pending_implementation" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">Closed/Implemented:</td>
                        <td id="closed_implemented" class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-8 bg-gray-50 p-4 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Activity Log</h3>

        {# --- Server-Side Search Form --- #}
        <form class="form-inline mb-4" method="GET" action="{{ url_for('routes.home') }}">
            <div class="input-group">
                <input type="text" name="search" class="form-control p-2 border border-gray-300 rounded-md w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search activities..." value="{{ search_query }}">
                <div class="input-group-append flex">
                    <button class="btn btn-outline-secondary px-4 py-2 bg-blue-500 text-white rounded-md ml-2 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500" type="submit">Search</button>
                    {% if search_query %}
                    <a href="{{ url_for('routes.home') }}" class="btn btn-outline-danger px-4 py-2 bg-red-500 text-white rounded-md ml-2 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">Clear Search</a>
                    {% endif %}
                </div>
            </div>
        </form>
        {# --- End Server-Side Search Form --- #}

        {% if recent_activities %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="activityLogTable">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for activity in recent_activities %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" data-utc-timestamp="{{ activity.timestamp.isoformat() }}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.username }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.event_type | replace('_', ' ') | title }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ activity.description }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- Pagination Controls --- #}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination flex justify-center space-x-1">
                {# Previous Page Link #}
                <li class="page-item {% if not pagination.has_prev %}opacity-50 cursor-not-allowed{% endif %}">
                    <a class="page-link px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-100"
                       href="{{ url_for('routes.home', page=pagination.prev_num, search=search_query) }}"
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                {# Page Numbers #}
                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if p %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link px-3 py-2 rounded-md border
                                {% if p == pagination.page %}
                                    bg-blue-600 text-white border-blue-600
                                {% else %}
                                    bg-white text-gray-700 border-gray-300 hover:bg-gray-100
                                {% endif %}"
                               href="{{ url_for('routes.home', page=p, search=search_query) }}">{{ p }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {# Next Page Link #}
                <li class="page-item {% if not pagination.has_next %}opacity-50 cursor-not-allowed{% endif %}">
                    <a class="page-link px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-100"
                       href="{{ url_for('routes.home', page=pagination.next_num, search=search_query) }}"
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {# --- End Pagination Controls --- #}

        {% else %}
        <p class="text-gray-600">No activity logs found{% if search_query %} for "{{ search_query }}"{% endif %}.</p>
        {% endif %}
    </div>

</div>

<script>
    // Variables to store previous bandwidth data for calculation
    let prevBytesSent = 0;
    let prevBytesRecv = 0;
    let lastBandwidthFetchTime = 0; // Timestamp of the last fetch

    const INTERFACE_CAPACITY_BPS = 125000000;

    // Helper function to format bytes per second
    function formatBytesPerSecond(bytes) {
        if (bytes < 1024) {
            return `${bytes.toFixed(1)} B/s`;
        } else if (bytes < 1024 * 1024) {
            return `${(bytes / 1024).toFixed(1)} KB/s`;
        } else if (bytes < 1024 * 1024 * 1024) {
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB/s`;
        } else {
            return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB/s`;
        }
    }

    // Helper function to determine color based on percentage usage (Frontend version)
    function getUsageColorFrontend(percentage, amber_threshold, red_threshold) {
        if (percentage >= red_threshold) {
            return 'red';
        } else if (percentage >= amber_threshold) {
            return 'amber';
        } else {
            return 'green';
        }
    }

    // Helper function to apply status styles to table cells
    function applyStatusStyle(elementId, statusData) {
        const element = document.getElementById(elementId);
        if (!element) return;

        // Clear existing classes that control color and background
        element.classList.remove('text-gray-500', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-gray-100', 'text-gray-800');

        // Add common badge styling
        element.classList.add('rounded-full', 'inline-block', 'px-3', 'py-1', 'whitespace-nowrap', 'text-sm', 'font-semibold');

        // Apply specific color classes based on the 'color' from backend or calculated frontend
        if (statusData.color === 'green') {
            element.classList.add('bg-green-100', 'text-green-800');
        } else if (statusData.color === 'red') {
            element.classList.add('bg-red-100', 'text-red-800');
        } else if (statusData.color === 'amber' || statusData.color === 'yellow') {
            element.classList.add('bg-yellow-100', 'text-yellow-800');
        } else { // Default for 'unknown' or other statuses
            element.classList.add('bg-gray-100', 'text-gray-800');
        }

        element.textContent = statusData.text || 'N/A';
    }

    // Function to fetch and update System Status (including bandwidth rate)
    async function fetchSystemStatus() {
        try {
            const response = await fetch('/api/dashboard/system-status');
            const data = await response.json();
            const currentTime = Date.now(); // Current timestamp in milliseconds

            // --- Apply styles for CPU, Memory, Disk (now objects from backend) ---
            applyStatusStyle('cpu_load', data.cpu_load || {text: 'N/A', color: 'gray'});
            applyStatusStyle('memory_load', data.memory_load || {text: 'N/A', color: 'gray'});
            applyStatusStyle('disk_space', data.disk_space || {text: 'N/A', color: 'gray'});

            // --- Apply styles for Firework, Nginx, Gunicorn, PostgreSQL ---
            applyStatusStyle('app_status', data.firework_app || {text: 'N/A', color: 'gray'});
            applyStatusStyle('nginx_status', data.nginx || {text: 'N/A', color: 'gray'});
            applyStatusStyle('gunicorn_status', data.gunicorn || {text: 'N/A', color: 'gray'});
            applyStatusStyle('postgres_status', data.postgres || {text: 'N/A', color: 'gray'});

            // --- Bandwidth Calculation Logic ---
            let bandwidthText = 'N/A';
            let bandwidthColor = 'gray';

            if (data.bandwidth_error) {
                bandwidthText = data.bandwidth_error;
                bandwidthColor = 'red'; // Error means red
            } else if (lastBandwidthFetchTime === 0) {
                bandwidthText = 'Collecting data...';
                bandwidthColor = 'gray';
            } else {
                const timeDiffSeconds = (currentTime - lastBandwidthFetchTime) / 1000; // Convert ms to seconds

                if (timeDiffSeconds > 0) {
                    const sentDiff = data.bandwidth_bytes_sent - prevBytesSent;
                    const recvDiff = data.bandwidth_bytes_recv - prevBytesRecv;

                    const actualSentDiff = Math.max(0, sentDiff);
                    const actualRecvDiff = Math.max(0, recvDiff);

                    const sentRate = actualSentDiff / timeDiffSeconds;
                    const recvRate = actualRecvDiff / timeDiffSeconds;
                    const totalRate = sentRate + recvRate;

                    bandwidthText = `Sent: ${formatBytesPerSecond(sentRate)}, Recv: ${formatBytesPerSecond(recvRate)}`;

                    // Calculate bandwidth utilization percentage
                    const bandwidthUtilizationPercent = (totalRate / INTERFACE_CAPACITY_BPS) * 100;
                    bandwidthColor = getUsageColorFrontend(bandwidthUtilizationPercent, 70, 90); // Amber at 70%, Red at 90%

                } else {
                    bandwidthText = 'Calculating...';
                    bandwidthColor = 'gray';
                }
            }
            // Apply bandwidth status style
            applyStatusStyle('bandwidth', {text: bandwidthText, color: bandwidthColor});

            // Store current values for the next calculation
            prevBytesSent = data.bandwidth_bytes_sent;
            prevBytesRecv = data.bandwidth_bytes_recv;
            lastBandwidthFetchTime = currentTime;

        } catch (error) {
            console.error('Error fetching system status:', error);
            // Update all elements to 'Error' and default gray style on fetch failure
            applyStatusStyle('cpu_load', {text: 'Error', color: 'gray'});
            applyStatusStyle('memory_load', {text: 'Error', color: 'gray'});
            applyStatusStyle('disk_space', {text: 'Error', color: 'gray'});
            applyStatusStyle('bandwidth', {text: 'Error', color: 'gray'});
            applyStatusStyle('app_status', {text: 'Error', color: 'gray'});
            applyStatusStyle('nginx_status', {text: 'Error', color: 'gray'});
            applyStatusStyle('gunicorn_status', {text: 'Error', color: 'gray'});
            applyStatusStyle('postgres_status', {text: 'Error', color: 'gray'});
        }
    }

    // Function to fetch and update Application Status
    async function fetchApplicationStatus() {
        try {
            const response = await fetch('/api/dashboard/application-status');
            const data = await response.json();

            document.getElementById('open_tickets').textContent = data.open_tickets !== undefined ? data.open_tickets : '';
            document.getElementById('pending_approval').textContent = data.pending_approval !== undefined ? data.pending_approval : '';
            document.getElementById('pending_implementation').textContent = data.pending_implementation !== undefined ? data.pending_implementation : '';
            document.getElementById('closed_implemented').textContent = data.closed_implemented !== undefined ? data.closed_implemented : '';

        } catch (error) {
            console.error('Error fetching application status:', error);
            document.getElementById('open_tickets').textContent = 'Error';
            document.getElementById('pending_approval').textContent = 'Error';
            document.getElementById('pending_implementation').textContent = 'Error';
            document.getElementById('closed_implemented').textContent = 'Error';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Fetch data initially
        fetchSystemStatus(); // Call first to initialize bandwidth counters
        fetchApplicationStatus();

        // Refresh data periodically
        setInterval(fetchSystemStatus, 3000);
        setInterval(fetchApplicationStatus, 15000);

        const timestampCells = document.querySelectorAll('td[data-utc-timestamp]');
        
        const dateFormatter = new Intl.DateTimeFormat('en-GB', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });

        timestampCells.forEach(cell => {
            const utcTimestampString = cell.getAttribute('data-utc-timestamp');
            if (utcTimestampString) {
                try {
                    const date = new Date(utcTimestampString);
                    if (!isNaN(date.getTime())) { // Check if the date is valid
                        cell.textContent = dateFormatter.format(date);
                    } else {
                        cell.textContent = 'Invalid Date';
                    }
                } catch (e) {
                    console.error('Error parsing date:', e);
                    cell.textContent = 'Invalid Date';
                }
            }
        });
    });
</script>
{% endblock %}
