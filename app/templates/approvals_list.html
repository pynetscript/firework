{% extends "base.html" %} 
 {% block content %} 
 <div class="container mx-auto p-4 bg-white rounded-lg shadow-lg my-8 w-full max-w-full"> 
     <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Approval</h2> 
     <div class="flex justify-end mb-4"> 
         <input type="text" id="approvalSearchInput" placeholder="Search..." 
                class="p-2 border border-gray-300 rounded-md w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500"> 
     </div> 
     {% if rules %} 
     <div class="block"> 
         <table class="w-full bg-white rounded-lg overflow-hidden shadow-md table-auto text-sm" id="approvalsTable"> 
             <thead> 
                 <tr class="bg-gray-100 text-gray-700 uppercase text-xs leading-normal"> 
                     <th class="py-2 px-2 text-left">ID</th> 
                     <th class="py-2 px-2 text-left">Source IP</th> 
                     <th class="py-2 px-2 text-left">Destination IP</th> 
                     <th class="py-2 px-2 text-left">Protocol</th> 
                     <th class="py-2 px-2 text-left">Port</th> 
                     <th class="py-2 px-2 text-left">Status</th> 
                     <th class="py-2 px-2 text-left">Approval Status</th> 
                     <th class="py-2 px-2 text-left">Firewalls Involved</th> 
                     <th class="py-2 px-2 text-left">Firewalls To Implement</th> 
                     <th class="py-2 px-2 text-left">Firewalls Implemented</th> 
                     <th class="py-2 px-2 text-left">Created At</th> 
                     <th class="py-2 px-2 text-left">Approved At</th> 
                     <th class="py-2 px-2 text-left">Implemented At</th> 
                     <th class="py-2 px-2 text-center">Action</th> 
                 </tr> 
             </thead> 
             <tbody class="text-gray-600 text-xs font-light"> 
                 {% for rule in rules %}
                 <tr class="border-b border-gray-200 hover:bg-gray-100"> 
                     <td class="py-2 px-2 text-left">{{ rule.id }}</td> 
                     <td class="py-2 px-2 text-left break-all">{{ rule.source_ip }}</td> 
                     <td class="py-2 px-2 text-left break-all">{{ rule.destination_ip }}</td> 
                     <td class="py-2 px-2 text-left break-words">{{ rule.protocol }}</td> 
                     <td class="py-2 px-2 text-left break-words">{% if rule.ports %}{{ rule.ports | join(', ') }}{% else %}N/A{% endif %}</td> 
                     <td class="py-2 px-2 text-left break-words">{{ rule.status }}</td> 
                     <td class="py-2 px-2 text-left break-words">{{ rule.approval_status }}</td> 
                     <td class="py-2 px-2 text-left break-words"> 
                         {% if rule.firewalls_involved %}{{ rule.firewalls_involved | join(', ') }}{% else %}N/A{% endif %} 
                     </td> 
                     <td class="py-2 px-2 text-left break-words"> 
                         {% if rule.firewalls_to_provision %}<span class="text-red-600">{{ rule.firewalls_to_provision | join(', ') }}</span>{% else %}None{% endif %} 
                     </td> 
                     <td class="py-2 px-2 text-left break-words"> 
                         {% if rule.firewalls_already_configured %}<span class="text-green-600">{{ rule.firewalls_already_configured | join(', ') }}</span>{% else %}None{% endif %} 
                     </td> 
                     <td class="py-2 px-2 text-left break-words" data-utc-timestamp="{% if rule.created_at %}{{ rule.created_at.isoformat() }}Z{% endif %}">{{ rule.created_at.strftime('%Y-%m-%d %H:%M:%S') if rule.created_at else 'N/A' }}</td>
                     <td class="py-2 px-2 text-left break-words" data-utc-timestamp="{% if rule.approved_at %}{{ rule.approved_at.isoformat() }}Z{% endif %}">{{ rule.approved_at.strftime('%Y-%m-%d %H:%M:%S') if rule.approved_at else 'N/A' }}</td>
                     <td class="py-2 px-2 text-left break-words" data-utc-timestamp="{% if rule.implemented_at %}{{ rule.implemented_at.isoformat() }}Z{% endif %}">{{ rule.implemented_at.strftime('%Y-%m-%d %H:%M:%S') if rule.implemented_at else 'N/A' }}</td>
                     <td class="py-2 px-2 text-center whitespace-nowrap"> 
                         {# Only show Review button if approval_status is 'Pending Approval' #} 
                         {% if rule.approval_status == 'Pending Approval' %} 
                         <a href="{{ url_for('routes.approve_deny_request', rule_id=rule.id) }}" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-xs shadow-md transition duration-300 ease-in-out transform hover:scale-105"> 
                             Review 
                         </a> 
                         {% else %} 
                             <span class="text-gray-500 text-xs">-</span> 
                         {% endif %} 
                     </td> 
                 </tr> 
                 {% endfor %} 
             </tbody> 
         </table> 
     </div> 
     {% else %} 
     <p class="text-center text-gray-600 mt-4">No requests found.</p> 
     {% endif %} 
     <div class="text-center mt-8"> 
         <a href="{{ url_for('routes.home') }}" class="text-blue-500 hover:text-blue-700 text-sm font-semibold">‚Üê Back to Home</a> 
     </div> 
 </div> 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const approvalSearchInput = document.getElementById('approvalSearchInput');
        const approvalsTableBody = document.querySelector('#approvalsTable tbody');
        const tableRows = approvalsTableBody ? approvalsTableBody.querySelectorAll('tr') : [];

        if (approvalSearchInput && approvalsTableBody) { // Ensure elements exist before adding listener
            approvalSearchInput.addEventListener('input', function() {
                const searchTerm = approvalSearchInput.value.toLowerCase();

                tableRows.forEach(function(row) {
                    // Get all text content from the cells in the current row for broad search
                    const rowText = row.textContent.toLowerCase();

                    if (rowText.includes(searchTerm)) {
                        row.style.display = ''; // Show the row
                    } else {
                        row.style.display = 'none'; // Hide the row
                    }
                });
            });
        }

        // --- START Timezone Conversion (Updated for DD/MM/YYYY HH:MM:SS format) ---
        const timestampCells = document.querySelectorAll('#approvalsTable tbody td[data-utc-timestamp]');
        timestampCells.forEach(cell => {
            const utcTimestampString = cell.getAttribute('data-utc-timestamp');
            if (utcTimestampString) {
                const date = new Date(utcTimestampString);

                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false // Use 24-hour format
                };

                // Format the date and time using 'en-GB' locale for DD/MM/YYYY
                let formattedDateTime = date.toLocaleString('en-GB', options);

                // Remove the comma and replace it with a space to match the desired format
                formattedDateTime = formattedDateTime.replace(', ', ' ');

                cell.textContent = formattedDateTime;
            }
        });
        // --- END Timezone Conversion ---
    });
</script>
 {% endblock %} 
