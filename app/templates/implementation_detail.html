{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8 max-w-2xl">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Implementation</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>ID:</strong> <span class="font-semibold text-gray-800">{{ rule.id }}</span></p>
            <p class="text-gray-600"><strong>Source IP:</strong> <span class="font-semibold text-gray-800">{{ rule.source_ip }}</span></p>
            <p class="text-gray-600"><strong>Destination IP:</strong> <span class="font-semibold text-gray-800">{{ rule.destination_ip }}</span></p>
            <p class="text-gray-600"><strong>Protocol:</strong> <span class="font-semibold text-gray-800">{{ rule.protocol }}</span></p>
            <p class="text-gray-600"><strong>Port:</strong> <span class="font-semibold text-gray-800">{{ rule.ports | join(', ') if rule.ports else 'N/A' }}</span></p>
        </div>
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>Status:</strong> <span class="font-semibold text-blue-600">{{ rule.status }}</span></p>
            <p class="text-gray-600"><strong>Approval Status:</strong> <span class="font-semibold text-purple-600">{{ rule.approval_status }}</span></p>
            <p class="text-gray-600"><strong>Approver Comments:</strong> <span class="text-gray-800">{{ rule.approval_comment if rule.approval_comment else 'N/A' }}</span></p>
            <p class="text-gray-600"><strong>Firewalls Involved:</strong>
                {% if rule.firewalls_involved %}
                    <span class="font-semibold text-gray-800">{{ rule.firewalls_involved | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">N/A</span>
                {% endif %}
            </p>
            <p class="text-gray-600"><strong>Firewalls to Implement:</strong>
                {% if rule.firewalls_to_provision %}
                    <span class="font-semibold text-red-600">{{ rule.firewalls_to_provision | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None</span>
                {% endif %}
            </p>
            <p class="text-gray-600"><strong>Firewalls Implemented:</strong>
                {% if rule.firewalls_already_configured %}
                    <span class="font-semibold text-green-600">{{ rule.firewalls_already_configured | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None</span>
                {% endif %}
            </p>
            <p class="text-gray-600"><strong>Requester:</strong> <span class="font-semibold text-blue-600">{{ rule.requester_username if rule.requester_username else '' }}</span></p>
            <p class="text-gray-600"><strong>Approver:</strong> <span class="font-semibold text-blue-600">{{ rule.approver_username if rule.approver_username else '' }}</span></p> 
       </div>
    </div>

    {% if rule.status == 'Pending Implementation' %}
    {# Only show the form if there are firewalls that *actually need* provisioning #}
    {% if rule.firewalls_to_provision %}
    <form method="POST" action="{{ url_for('routes.implement_rule', rule_id=rule.id) }}" class="space-y-4" id="implementationForm">
        <div>
            <label for="implementer_comment" class="block text-gray-700 text-sm font-bold mb-2">Comments:</label>
            <textarea id="implementer_comment" name="implementer_comment" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-y"></textarea>
        </div>

        <div class="flex justify-center space-x-4">
            <button type="button" id="provisionRuleBtn" name="action" value="provision" 
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Implement
            </button>
            <button type="submit" name="action" value="decline_implementation" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Decline</button>
        </div>
    </form>
    {% else %}
        <p class="text-center text-lg text-green-700">Request has been approved, and no firewalls require implementation. It's already completed or awaiting final status update.</p>
    {% endif %}
    {% else %}
        <p class="text-center text-lg text-gray-600">Request is currently {{ rule.status }}. No implementation action is available here.</p>
    {% endif %}

    <div class="text-center mt-8">
        <a href="{{ url_for('routes.implementation_list') }}" class="text-blue-500 hover:text-blue-700 text-sm font-semibold">‚Üê Back to Implementation</a>
    </div>
</div>

<script>
    function showLoading(buttonId, loadingText) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${loadingText}`;
        }
    }

    // Button click and form submission
    document.addEventListener('DOMContentLoaded', function() {
        const provisionBtn = document.getElementById('provisionRuleBtn');
        const form = document.getElementById('implementationForm');

        if (provisionBtn && form) {
            provisionBtn.addEventListener('click', function() {
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'provision';
                form.appendChild(actionInput);

                showLoading('provisionRuleBtn', 'Provisioning...');
                
                setTimeout(() => {
                    form.submit();
                }, 50);
            });
        }
    });
</script>
{% endblock %}
