{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8 max-w-2xl">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Implement Network Rule #{{ rule.id }}</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>Source IP:</strong> <span class="font-semibold text-gray-800">{{ rule.source_ip }}</span></p>
            <p class="text-gray-600"><strong>Destination IP:</strong> <span class="font-semibold text-gray-800">{{ rule.destination_ip }}</span></p>
            <p class="text-gray-600"><strong>Protocol:</strong> <span class="font-semibold text-gray-800">{{ rule.protocol }}</span></p>
            <p class="text-gray-600"><strong>Port:</strong> <span class="font-semibold text-gray-800">{{ rule.port }}</span></p>
        </div>
        <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-gray-600"><strong>Current Status:</strong> <span class="font-semibold text-blue-600">{{ rule.status }}</span></p>
            <p class="text-gray-600"><strong>Approval Status:</strong> <span class="font-semibold text-purple-600">{{ rule.approval_status }}</span></p>
            <p class="text-gray-600"><strong>Approver Comments:</strong> <span class="text-gray-800">{{ rule.approver_comment if rule.approver_comment else 'N/A' }}</span></p>
            <p class="text-gray-600"><strong>Firewalls Involved:</strong> 
                {% if rule.firewalls_involved %}
                    <span class="font-semibold text-gray-800">{{ rule.firewalls_involved | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">N/A</span>
                {% endif %}
            </p>

            {# NEW: Display firewalls to provision and already configured #}
            <p class="text-gray-600 mt-2"><strong>Firewalls Requiring Provisioning:</strong> 
                {% if rule.firewalls_to_provision %}
                    <span class="font-semibold text-red-600">{{ rule.firewalls_to_provision | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None (Policy is already on all firewalls in path, or no firewalls involved)</span>
                {% endif %}
            </p>
            <p class="text-gray-600"><strong>Firewalls Already Configured:</strong> 
                {% if rule.firewalls_already_configured %}
                    <span class="font-semibold text-green-600">{{ rule.firewalls_already_configured | join(', ') }}</span>
                {% else %}
                    <span class="text-gray-500">None</span>
                {% endif %}
            </p>
        </div>
    </div>

    <h3 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Implementer Action</h3>
    {% if rule.status == 'Approved - Pending Implementation' %}
    {# Only show the form if there are firewalls that *actually need* provisioning #}
    {% if rule.firewalls_to_provision %}
    <form method="POST" action="{{ url_for('routes.implement_rule', rule_id=rule.id) }}" class="space-y-4">
        <div>
            <label for="implementer_comment" class="block text-gray-700 text-sm font-bold mb-2">Implementer Comments (Optional):</label>
            <textarea id="implementer_comment" name="implementer_comment" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline resize-y"></textarea>
        </div>
        
        <div class="flex justify-center space-x-4">
            <button type="submit" name="action" value="provision" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Provision Rule</button>
            <button type="submit" name="action" value="decline_implementation" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">Decline Implementation</button>
        </div>
    </form>
    {% else %}
        <p class="text-center text-lg text-green-700">This rule has been approved, and no firewalls require provisioning. It's already completed or awaiting final status update.</p>
        {# Add a button to manually mark as complete if needed, or rely on system to do it #}
    {% endif %}
    {% else %}
        <p class="text-center text-lg text-gray-600">This rule is currently {{ rule.status }}. No implementation action is available here.</p>
    {% endif %}

    <div class="text-center mt-8">
        <a href="{{ url_for('routes.implementation_list') }}" class="text-blue-500 hover:text-blue-700 text-sm font-semibold">‚Üê Back to Implementation List</a>
    </div>
</div>
{% endblock %}
