{% extends "base.html" %}
{% block content %}
<div class="container mx-auto p-6 bg-white rounded-lg shadow-lg my-8 w-full max-w-full">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Blacklist Rules</h2>

    <div class="flex justify-between mb-6 items-center">
        <div class="flex space-x-4">
            <a href="{{ url_for('routes.add_blacklist_rule') }}" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Add Rule
            </a>
            <a href="{{ url_for('routes.export_blacklist_csv') }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Export Rules
            </a>
        </div>
        <input type="text" id="blacklistSearchInput" placeholder="Search..."
               class="p-2 border border-gray-300 rounded-md w-1/3 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div class="flex justify-end mb-4">
        <button id="deleteSelectedButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 hidden">
            Delete Selected
        </button>
    </div>

    <div>
        <table id="blacklistRulesTable" class="min-w-full bg-white rounded-lg overflow-hidden shadow-md table-auto">
            <thead>
                <tr class="bg-gray-100 text-gray-700 uppercase text-xs leading-normal">
                    <th class="py-2 px-2 text-left">
                        <input type="checkbox" id="selectAllRules" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                    </th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">ID</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Sequence</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Rule Name</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Enabled</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Source IP</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Destination IP</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Protocol</th>
                    <th class="py-2 px-2 text-left whitespace-nowrap">Port</th>
                    <th class="py-2 px-2 text-left">Description</th>
                    <th class="py-2 px-2 text-left">Created At</th>
                    <th class="py-2 px-2 text-left">Created By</th>
                    <th class="py-2 px-2 text-left">Last Updated</th>
                    <th class="py-2 px-2 text-left">Last Updated By</th>
                    <th class="py-2 px-2 text-center whitespace-nowrap">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                <tr>
                    <td colspan="15" class="py-4 px-6 text-center text-gray-500">Loading blacklist rules...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="noRulesMessage" class="text-center text-gray-600 mt-4 hidden">No blacklist rules found.</div>

    <div id="responseMessage" class="mt-4 p-3 rounded-md text-center hidden"></div>

    <div class="text-center mt-8">
        <a href="{{ url_for('routes.home') }}" class="text-blue-500 hover:text-blue-700 text-sm font-semibold">‚Üê Back to Home</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const blacklistRulesTableBody = document.querySelector('#blacklistRulesTable tbody');
        const selectAllRulesCheckbox = document.getElementById('selectAllRules');
        const deleteSelectedButton = document.getElementById('deleteSelectedButton');
        const noRulesMessage = document.getElementById('noRulesMessage');
        const responseMessageDiv = document.getElementById('responseMessage');
        const blacklistSearchInput = document.getElementById('blacklistSearchInput');

        let allBlacklistRules = [];

        // Function to load and display blacklist rules
        async function loadBlacklistRules() {
            blacklistRulesTableBody.innerHTML = `<tr><td colspan="15" class="py-4 px-6 text-center text-gray-500">Loading blacklist rules...</td></tr>`;
            noRulesMessage.classList.add('hidden');
            deleteSelectedButton.classList.add('hidden');
            selectAllRulesCheckbox.checked = false;
            responseMessageDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/blacklist_rules');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rules = await response.json();
                allBlacklistRules = rules;
                filterBlacklistRules();
            } catch (error) {
                console.error('Error fetching blacklist rules:', error);
                blacklistRulesTableBody.innerHTML = `<tr><td colspan="15" class="py-4 px-6 text-center text-red-500">Failed to load rules. Please check server logs.</td></tr>`;
                showResponseMessage('Failed to load rules. Please check server logs.', 'error');
            }
        }

        // Function to filter and render rules
        function filterBlacklistRules() {
            const searchTerm = blacklistSearchInput.value.toLowerCase();
            const filteredRules = allBlacklistRules.filter(rule => {
                return (rule.id.toString().toLowerCase().includes(searchTerm) ||
                        rule.sequence.toString().toLowerCase().includes(searchTerm) ||
                        rule.rule_name.toLowerCase().includes(searchTerm) ||
                        (rule.source_ip && rule.source_ip.toLowerCase().includes(searchTerm)) ||
                        (rule.destination_ip && rule.destination_ip.toLowerCase().includes(searchTerm)) ||
                        (rule.protocol && rule.protocol.toLowerCase().includes(searchTerm)) ||
                        (rule.destination_port && rule.destination_port.toString().toLowerCase().includes(searchTerm)) ||
                        (rule.description && rule.description.toLowerCase().includes(searchTerm)) ||
                        (rule.created_at && formatTimestamp(rule.created_at, false).toLowerCase().includes(searchTerm)) ||
                        (rule.created_by_username && rule.created_by_username.toLowerCase().includes(searchTerm)) ||
                        (rule.updated_at && formatTimestamp(rule.updated_at, false).toLowerCase().includes(searchTerm)) ||
                        (rule.last_updated_by_username && rule.last_updated_by_username.toLowerCase().includes(searchTerm)) ||
                        (rule.enabled ? 'yes' : 'no').includes(searchTerm));
            });
            renderRulesTable(filteredRules);
        }

        const formatTimestamp = (timestamp, formattedHtml = true) => {
            if (timestamp) {
                try {
                    const date = new Date(timestamp);
                    const options = {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    };
                    const formattedString = date.toLocaleString('en-GB', options);
                    if (formattedHtml) {
                        return `<span data-utc-timestamp="${timestamp}">${formattedString}</span>`;
                    }
                    return formattedString;
                } catch (e) {
                    console.error('Error parsing date:', e);
                    return 'Invalid Date';
                }
            }
            return 'N/A';
        };

        // Function to render the rules table
        function renderRulesTable(rulesToRender) {
            blacklistRulesTableBody.innerHTML = '';
            if (rulesToRender.length === 0) {
                noRulesMessage.classList.remove('hidden');
                return;
            } else {
                noRulesMessage.classList.add('hidden');
            }

            rulesToRender.forEach(rule => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');

                row.innerHTML = `
                    <td class="py-2 px-2 text-left">
                        <input type="checkbox" class="rule-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" data-rule-id="${rule.id}">
                    </td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">
                        <a href="/admin/blacklist-rules/detail/${rule.id}" class="text-blue-600 hover:text-blue-800 hover:underline font-medium" data-rule-id="${rule.id}">
                            ${rule.id}
                        </a>
                    </td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.sequence}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.rule_name}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.enabled ? 'Yes' : 'No'}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.source_ip || 'Any'}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.destination_ip || 'Any'}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.protocol || 'Any'}</td>
                    <td class="py-2 px-2 text-left whitespace-nowrap">${rule.destination_port || 'Any'}</td>
                    <td class="py-2 px-2 text-left">${rule.description || 'N/A'}</td>
                    <td class="py-2 px-2 text-left">${formatTimestamp(rule.created_at)}</td>
                    <td class="py-2 px-2 text-left">${rule.created_by_username || 'N/A'}</td>
                    <td class="py-2 px-2 text-left">${formatTimestamp(rule.updated_at)}</td>
                    <td class="py-2 px-2 text-left">${rule.last_updated_by_username || 'N/A'}</td>
                    <td class="py-2 px-2 text-center whitespace-nowrap">
                        <button class="edit-rule-btn bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-md text-xs transition duration-300 ease-in-out transform hover:scale-105 mr-2" data-rule-id="${rule.id}">Edit</button>
                        <form data-delete-form action="/admin/blacklist-rules/delete/${rule.id}" method="POST" onsubmit="return confirm('Are you sure you want to delete rule ID ${rule.id}? This action cannot be undone.');" style="display:inline;">
                            <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-xs transition duration-300 ease-in-out transform hover:scale-105">
                                Delete
                            </button>
                        </form>
                    </td>
                `;
                blacklistRulesTableBody.appendChild(row);
            });
            updateDeleteSelectedButtonVisibility();
        }

        // Select All checkbox
        selectAllRulesCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.rule-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateDeleteSelectedButtonVisibility();
        });

        // Individual checkbox
        blacklistRulesTableBody.addEventListener('change', function(event) {
            if (event.target.classList.contains('rule-checkbox')) {
                updateDeleteSelectedButtonVisibility();
                // If any individual checkbox is unchecked, uncheck "Select All"
                if (!event.target.checked) {
                    selectAllRulesCheckbox.checked = false;
                } else {
                    // If all individual checkboxes are checked, check "Select All"
                    const allCheckboxes = document.querySelectorAll('.rule-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    selectAllRulesCheckbox.checked = allChecked;
                }
            }
        });

        // "Delete Selected" button
        function updateDeleteSelectedButtonVisibility() {
            const checkedCheckboxes = document.querySelectorAll('.rule-checkbox:checked');
            if (checkedCheckboxes.length > 0) {
                deleteSelectedButton.classList.remove('hidden');
            } else {
                deleteSelectedButton.classList.add('hidden');
            }
        }

        deleteSelectedButton.addEventListener('click', async function() {
            const selectedRuleIds = Array.from(document.querySelectorAll('.rule-checkbox:checked'))
                                     .map(cb => cb.dataset.ruleId);
            if (selectedRuleIds.length === 0) {
                showResponseMessage('Please select at least one rule to delete.', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedRuleIds.length} selected rule(s)?`)) {
                return;
            }

            try {
                const response = await fetch('/api/blacklist_rules', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ids: selectedRuleIds })
                });

                const result = await response.json();
                if (response.ok) {
                    showResponseMessage(result.message, 'success');
                    loadBlacklistRules(); // Reload rules after deletion
                } else {
                    showResponseMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting selected rules:', error);
                showResponseMessage('Network error: Could not connect to the server.', 'error');
            }
        });

        // Edit button
        blacklistRulesTableBody.addEventListener('click', async function(event) {
            if (event.target.classList.contains('edit-rule-btn')) {
                const ruleId = event.target.dataset.ruleId;
                window.location.href = `/admin/blacklist-rules/edit/${ruleId}`;
            }
        });

        function showResponseMessage(message, type) {
            responseMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') {
                responseMessageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                responseMessageDiv.classList.add('bg-red-100', 'text-red-800');
            }
            responseMessageDiv.innerHTML = `<p class="font-bold">${type.charAt(0).toUpperCase() + type.slice(1)}:</p><p>${message}</p>`;
            responseMessageDiv.classList.remove('hidden');
        }

        blacklistSearchInput.addEventListener('input', filterBlacklistRules);

        loadBlacklistRules();
    });
</script>

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>

{% endblock %}
