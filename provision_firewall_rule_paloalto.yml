---
- name: Provision Firewall Rule on Palo Alto
  hosts: "{{ firewalls | join(',') }}" # Dynamically target firewalls passed from Flask app
  gather_facts: no
  connection: network_cli
  collections:
    - paloaltonetworks.panos
  any_errors_fatal: true

  vars:
    rule_id: "{{ rule_id }}"
    source_ip: "{{ source_ip }}"
    destination_ip: "{{ destination_ip }}"
    protocol: "{{ protocol }}"
    dest_port: "{{ dest_port }}"
    rule_description: "{{ rule_description | default('Managed by Firework App') }}"

    # Define object names based on rule parameters for consistency
    src_addr_name: "h-{{ source_ip }}" # Use h-x.x.x.x format
    dst_addr_name: "h-{{ destination_ip }}" # Use h-x.x.x.x format

    # Define Palo Alto service name based on protocol and dest_port
    # Handles 'any', 'icmp', or specific protocol-dest_port combinations
    # Ensured this is a single line to prevent any whitespace issues from multi-line YAML
    pa_service_name: "{{ 'any' if protocol | lower == 'any' else ('ICMP' if protocol | lower == 'icmp' else (protocol | upper) + '-' + (dest_port | string)) }}"

    # Define Palo Alto protocol for service object (needs to be name, not number)
    # Ensure it's strictly 'tcp', 'udp', or 'icmp' for the module
    # Added | trim to ensure no trailing spaces, and ensured it's on a single line
    pa_protocol_for_service_object: "{{ protocol | lower | trim if protocol | string not in ['6', '17', '1'] else ({'6':'tcp', '17':'udp', '1':'icmp'}[protocol | string]) }}"

  tasks:
    - name: Debug Provisioning variables for Palo Alto
      debug:
        msg: "Provisioning Rule ID: {{ rule_id }}, Source: {{ source_ip }}, Dest: {{ destination_ip }}, Proto: {{ protocol }}, Port: {{ dest_port }}, Firewalls: {{ firewalls }}"

    - name: Create Palo Alto Source Address Object
      paloaltonetworks.panos.panos_address_object:
        provider:
          ip_address: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          api_key: "{{ ansible_api_key | default(omit) }}"
        name: "{{ src_addr_name }}"
        address_type: "ip-netmask"
        value: "{{ source_ip }}" # Corrected: Removed /32, supply only IP for host
        state: present
      when: inventory_hostname in groups['paloalto'] | default([])
      # NO ignore_errors: yes HERE. This task MUST succeed.

    - name: Create Palo Alto Destination Address Object
      paloaltonetworks.panos.panos_address_object:
        provider:
          ip_address: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          api_key: "{{ ansible_api_key | default(omit) }}"
        name: "{{ dst_addr_name }}"
        address_type: "ip-netmask"
        value: "{{ destination_ip }}" # Corrected: Removed /32, supply only IP for host
        state: present
      when: inventory_hostname in groups['paloalto'] | default([])
      # NO ignore_errors: yes HERE. This task MUST succeed.

    - name: Create Palo Alto Service Object
      paloaltonetworks.panos.panos_service_object:
        provider:
          ip_address: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          api_key: "{{ ansible_api_key | default(omit) }}"
        name: "{{ pa_service_name }}" # Use the dynamically generated service name
        protocol: "{{ pa_protocol_for_service_object }}" # Use the mapped protocol name (tcp, udp, icmp)
        destination_port: "{{ dest_port }}" # Use dest_port
        state: present
      when:
        - inventory_hostname in groups['paloalto'] | default([])
        - protocol | lower != 'any' # Only create specific service if not 'any'
      # NO ignore_errors: yes HERE. This task MUST succeed.

    - name: Create Palo Alto Security Rule
      paloaltonetworks.panos.panos_security_rule:
        provider:
          ip_address: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          api_key: "{{ ansible_api_key | default(omit) }}" # Use API key if available
        rule_name: "firework-{{ rule_id }}"
        description: "{{ rule_description }}"
        source_zone: ["any"]
        destination_zone: ["any"]
        source_ip: "{{ source_ip }}"
        destination_ip: "{{ destination_ip }}"
        application: ["any"]
        service: "{{ pa_service_name }}"
        action: allow
        log_start: true
        log_end: true
      when: inventory_hostname in groups['paloalto'] | default([]) # Ensure group exists
      # NO ignore_errors: yes HERE. This task MUST succeed.

    - name: Commit changes on Palo Alto (if applicable)
      paloaltonetworks.panos.panos_commit_firewall: # Updated to use specific commit module
        provider:
          ip_address: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"
          api_key: "{{ ansible_api_key | default(omit) }}"
      when: inventory_hostname in groups['paloalto'] | default([])
      ignore_errors: yes # Keep ignore_errors for commit as it might fail if no changes were made due to earlier failures
